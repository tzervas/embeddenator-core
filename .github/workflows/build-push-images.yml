name: Build and Push Holographic OS Images

on:
  workflow_dispatch:
    inputs:
      os_selections:
        description: 'OS configurations to build (comma-separated, amd64 only for CI performance)'
        required: true
        default: 'debian-stable-amd64,debian-testing-amd64,ubuntu-stable-amd64'
        type: string
      tag_suffix:
        description: 'Tag suffix (e.g., -dev, -rc1, empty for release)'
        required: false
        default: '-dev'
        type: string
      push_to_ghcr:
        description: 'Push images to GHCR'
        required: true
        default: true
        type: boolean
      run_tests:
        description: 'Run full test suite before building'
        required: true
        default: true
        type: boolean

permissions:
  contents: read
  packages: write

jobs:
  test:
    if: ${{ inputs.run_tests }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Run test suite
        run: python3 test_runner.py
      
      - name: Verify test count
        run: |
          OUTPUT=$(python3 test_runner.py)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "Total Tests:   24"; then
            echo "✅ All 24 tests accounted for"
          else
            echo "❌ Test count mismatch"
            exit 1
          fi

  # Generate matrix from comma-separated input
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate matrix from input
        id: set-matrix
        run: |
          # Convert comma-separated string to JSON array
          INPUT="${{ inputs.os_selections }}"
          if [ -z "$INPUT" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            # Use jq to properly format as JSON array
            echo "$INPUT" | jq -R 'split(",")' | jq -c '.' > matrix.json
            MATRIX=$(cat matrix.json)
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
            echo "Generated matrix: $MATRIX"
          fi

  build-and-push:
    needs: [test, prepare-matrix]
    if: ${{ always() && (needs.test.result == 'success' || needs.test.result == 'skipped') }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os_config: ${{ fromJSON(needs.prepare-matrix.outputs.matrix) }}
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        if: ${{ inputs.push_to_ghcr }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Parse OS configuration
        id: parse
        run: |
          # Parse: debian-stable-amd64 -> os=debian, version=stable, arch=amd64
          CONFIG="${{ matrix.os_config }}"
          IFS='-' read -r os version arch <<< "$CONFIG"
          echo "os=$os" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "arch=$arch" >> $GITHUB_OUTPUT
          echo "config=$CONFIG" >> $GITHUB_OUTPUT
          echo "Parsed: os=$os, version=$version, arch=$arch"
      
      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Build holographic OS image
        run: |
          python3 build_holographic_os.py \
            --os "${{ steps.parse.outputs.os }}" \
            --version "${{ steps.parse.outputs.version }}" \
            --arch "${{ steps.parse.outputs.arch }}" \
            --tag-suffix "${{ inputs.tag_suffix }}" \
            --verbose
      
      - name: Tag image for GHCR
        if: ${{ inputs.push_to_ghcr }}
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ inputs.tag_suffix }}"
          CONFIG="${{ steps.parse.outputs.config }}"
          
          # Tag the built image
          docker tag "embeddenator-holographic-${CONFIG}:latest" \
            "ghcr.io/${{ github.repository_owner }}/embeddenator-holographic-${CONFIG}:${VERSION}"
          
          docker tag "embeddenator-holographic-${CONFIG}:latest" \
            "ghcr.io/${{ github.repository_owner }}/embeddenator-holographic-${CONFIG}:latest"
      
      - name: Push to GHCR
        if: ${{ inputs.push_to_ghcr }}
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ inputs.tag_suffix }}"
          CONFIG="${{ steps.parse.outputs.config }}"
          
          docker push "ghcr.io/${{ github.repository_owner }}/embeddenator-holographic-${CONFIG}:${VERSION}"
          docker push "ghcr.io/${{ github.repository_owner }}/embeddenator-holographic-${CONFIG}:latest"
      
      - name: Generate image manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ inputs.tag_suffix }}"
          CONFIG="${{ steps.parse.outputs.config }}"
          
          cat > "manifest-${CONFIG}.json" <<EOF
          {
            "image": "embeddenator-holographic-${CONFIG}",
            "version": "${VERSION}",
            "os": "${{ steps.parse.outputs.os }}",
            "os_version": "${{ steps.parse.outputs.version }}",
            "arch": "${{ steps.parse.outputs.arch }}",
            "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}"
          }
          EOF
      
      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest-${{ steps.parse.outputs.config }}
          path: manifest-*.json
          retention-days: 30

  summary:
    needs: [prepare-matrix, build-and-push]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all manifests
        uses: actions/download-artifact@v4.1.3
        with:
          pattern: manifest-*
          merge-multiple: true
      
      - name: Generate build summary
        run: |
          echo "# Holographic OS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build-and-push.outputs.version }}${{ inputs.tag_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pushed to GHCR:** ${{ inputs.push_to_ghcr }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Built Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for manifest in manifest-*.json; do
            if [ -f "$manifest" ]; then
              CONFIG=$(jq -r '.image' "$manifest" | sed 's/embeddenator-holographic-//')
              OS=$(jq -r '.os' "$manifest")
              VERSION=$(jq -r '.os_version' "$manifest")
              ARCH=$(jq -r '.arch' "$manifest")
              
              echo "- ✅ **${CONFIG}** (${OS}:${VERSION} ${ARCH})" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Images are available at: \`ghcr.io/${{ github.repository_owner }}/embeddenator-holographic-*\`" >> $GITHUB_STEP_SUMMARY
